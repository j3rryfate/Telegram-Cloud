<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TG Cloud - 2FA Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-10">
    <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-2xl font-bold mb-6 text-blue-400 text-center">Telegram Login</h2>
        
        <div id="auth-flow">
            <input id="phone" type="text" placeholder="+959..." class="w-full p-3 bg-gray-900 rounded mb-4 outline-none border border-gray-700">
            <button onclick="sendOTP()" id="btn-send" class="w-full bg-blue-600 py-3 rounded font-bold mb-4">Send OTP</button>

            <div id="otp-area" class="hidden">
                <input id="otp" type="text" placeholder="Enter OTP" class="w-full p-3 bg-gray-900 rounded mb-4 outline-none border border-green-600">
                <button onclick="verifyOTP()" id="btn-verify" class="w-full bg-green-600 py-3 rounded font-bold mb-4">Verify OTP</button>
            </div>

            <div id="password-area" class="hidden">
                <p class="text-sm text-yellow-400 mb-2 italic">2FA Password Required!</p>
                <input id="password" type="password" placeholder="Enter 2FA Password" class="w-full p-3 bg-gray-900 rounded mb-4 outline-none border border-yellow-600">
                <button onclick="verifyPassword()" id="btn-pwd" class="w-full bg-yellow-600 py-3 rounded font-bold">Login with Password</button>
            </div>
        </div>
    </div>

    <script>
        let phoneCodeHash, phoneNumber;

        async function sendOTP() {
            phoneNumber = document.getElementById('phone').value;
            const res = await fetch('/api/auth/send-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: phoneNumber })
            });
            const data = await res.json();
            if(data.success) {
                phoneCodeHash = data.phoneCodeHash;
                document.getElementById('otp-area').classList.remove('hidden');
                alert("OTP Sent!");
            } else { alert(data.error); }
        }

        async function verifyOTP() {
            const code = document.getElementById('otp').value;
            const res = await fetch('/api/auth/verify-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: phoneNumber, code, phoneCodeHash })
            });
            const data = await res.json();
            
            if (data.requiresPassword) {
                document.getElementById('password-area').classList.remove('hidden');
                alert("This account has 2FA. Please enter your password.");
            } else if (data.success) {
                alert("Success!"); window.location.reload();
            } else { alert(data.error); }
        }

        async function verifyPassword() {
            const password = document.getElementById('password').value;
            const res = await fetch('/api/auth/verify-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: phoneNumber, password })
            });
            const data = await res.json();
            if(data.success) {
                alert("Login Success!"); window.location.reload();
            } else { alert(data.error); }
        }
    </script>
</body>
</html>
