<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Cloud - Modern Telegram Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-effect {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

    <nav class="sticky top-0 z-50 glass-effect p-4 mb-8">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid min-w-[24px] fa-cloud text-blue-500 text-2xl"></i>
                <span class="text-xl font-bold tracking-tight">TG <span class="text-blue-500">Cloud</span></span>
            </div>
            <div id="user-status" class="text-sm text-gray-400">
                Not Connected
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 pb-20">
        
        <section id="login-card" class="bg-gray-800 rounded-2xl p-8 shadow-2xl border border-gray-700 mb-8">
            <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
                <i class="fa-solid fa-shield-halved text-blue-400"></i> Telegram Login
            </h2>
            
            <div id="phone-input-group">
                <label class="block text-sm text-gray-400 mb-2">Phone Number (International Format)</label>
                <input id="phone" type="text" placeholder="+959..." 
                    class="w-full bg-gray-900 border border-gray-600 rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none transition-all mb-4">
                <button onclick="sendOTP()" id="btn-send" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold transition-all flex justify-center items-center gap-2">
                    <span>Send OTP</span>
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <div id="otp-input-group" class="hidden mt-6 pt-6 border-t border-gray-700">
                <label class="block text-sm text-gray-400 mb-2">Enter 5-digit OTP Code</label>
                <input id="otp" type="text" placeholder="12345" 
                    class="w-full bg-gray-900 border border-gray-600 rounded-xl p-4 focus:ring-2 focus:ring-green-500 outline-none transition-all mb-4 text-center text-2xl tracking-[1rem]">
                <button onclick="verifyOTP()" id="btn-verify" class="w-full bg-green-600 hover:bg-green-700 py-4 rounded-xl font-bold transition-all">
                    Verify & Login
                </button>
            </div>
        </section>

        <section class="bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 overflow-hidden">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                <h2 class="text-xl font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-folder-open text-yellow-500"></i> My Cloud Files
                </h2>
                <button onclick="loadFiles()" class="p-2 hover:bg-gray-700 rounded-lg transition-colors text-blue-400">
                    <i class="fa-solid fa-rotate"></i> Refresh
                </button>
            </div>

            <div id="file-list" class="divide-y divide-gray-700">
                <div class="p-20 text-center text-gray-500">
                    <i class="fa-solid fa-box-open text-5xl mb-4 block"></i>
                    <p>Login to view your Telegram files</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        let currentPhoneCodeHash = null;
        let currentPhoneNumber = null;

        async function sendOTP() {
            const phone = document.getElementById('phone').value;
            const btn = document.getElementById('btn-send');
            
            if (!phone) return alert("Please enter phone number");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Sending...';

            try {
                const res = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                const data = await res.json();

                if (data.success) {
                    currentPhoneCodeHash = data.phoneCodeHash;
                    currentPhoneNumber = phone;
                    document.getElementById('otp-input-group').classList.remove('hidden');
                    document.getElementById('phone-input-group').classList.add('opacity-50');
                    alert("OTP Sent! Check your Telegram app.");
                } else {
                    alert("Error: " + data.error);
                }
            } catch (err) {
                alert("Server Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Send OTP';
            }
        }

        async function verifyOTP() {
            const code = document.getElementById('otp').value;
            const btn = document.getElementById('btn-verify');

            if (!code) return alert("Please enter OTP code");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Verifying...';

            try {
                const res = await fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: currentPhoneNumber, 
                        code: code, 
                        phoneCodeHash: currentPhoneCodeHash 
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert("Login Successful!");
                    document.getElementById('login-card').classList.add('hidden');
                    document.getElementById('user-status').innerText = "Connected: " + currentPhoneNumber;
                    loadFiles();
                } else {
                    alert("Verification Failed: " + data.error);
                }
            } catch (err) {
                alert("Server Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Verify & Login';
            }
        }

        async function loadFiles() {
            const list = document.getElementById('file-list');
            list.innerHTML = '<div class="p-10 text-center"><i class="fa-solid fa-spinner animate-spin text-3xl"></i></div>';

            try {
                const res = await fetch('/api/files');
                const files = await res.json();

                if (files.error) {
                    list.innerHTML = `<div class="p-10 text-center text-red-400">${files.error}</div>`;
                    return;
                }

                if (files.length === 0) {
                    list.innerHTML = '<div class="p-10 text-center text-gray-500">No files found in the channel.</div>';
                    return;
                }

                list.innerHTML = files.map(f => `
                    <div class="p-4 hover:bg-gray-700/50 transition-colors flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg bg-gray-900 flex items-center justify-center text-blue-400">
                                <i class="fa-solid ${getFileIcon(f.type)} text-xl"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-200">${f.text.substring(0, 30)}${f.text.length > 30 ? '...' : ''}</p>
                                <p class="text-xs text-gray-500">${new Date(f.date * 1000).toLocaleString()}</p>
                            </div>
                        </div>
                        <a href="/api/download/${f.id}" target="_blank" 
                            class="bg-gray-900 group-hover:bg-blue-600 p-3 rounded-xl transition-all">
                            <i class="fa-solid fa-download"></i>
                        </a>
                    </div>
                `).join('');

            } catch (err) {
                list.innerHTML = `<div class="p-10 text-center text-red-400">Failed to load files</div>`;
            }
        }

        function getFileIcon(type) {
            if (type.includes('Photo')) return 'fa-image';
            if (type.includes('Document')) return 'fa-file-lines';
            if (type.includes('Video')) return 'fa-video';
            return 'fa-file';
        }
    </script>
</body>
</html>
